<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡å°‚ç”¨ãƒšãƒ¼ã‚¸ | æ™‹ãƒãƒ«ã‚µãƒ³ch</title>
  <style>
    :root{
      --bgA:#fff4f6; --bgB:#fffdfe; --bgC:#f3fdff; --ink:#1f2937; --muted:#6b7280;
      --p:#ff4d6d; --p2:#ffb703; --p3:#4cc9f0; --shadow: 0 18px 50px rgba(0,0,0,0.12);
      --r: 18px; --max: 1100px;
    }
    body { 
      margin:0; 
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", sans-serif; 
      background: linear-gradient(135deg, var(--bgA), var(--bgC)); 
      min-height:100vh; 
      color:var(--ink); 
    }
    .container { 
      width: min(var(--max), calc(100% - 28px)); 
      margin-inline:auto; 
      padding:60px 0; 
    }
    .panel { 
      background:#fff; 
      border-radius:var(--r); 
      box-shadow:var(--shadow); 
      padding:40px; 
      max-width: 900px;
      margin: 0 auto;
    }
    h1 { 
      text-align:center; 
      font-size:clamp(24px,5vw,36px); 
      margin-bottom:20px; 
    }
    .status { 
      text-align:center; 
      font-size:20px; 
      font-weight:900; 
      padding:20px; 
      border-radius:16px; 
      margin-bottom:40px; 
    }
    .premium { 
      background:linear-gradient(135deg,var(--p),var(--p2)); 
      color:#fff; 
    }
    .not-premium { 
      background:#fee2e2; 
      color:#991b1b; 
    }
    .checking {
      background:#fef3c7;
      color:#92400e;
    }
    .btn-primary { 
      display:block; 
      width:100%; 
      max-width:300px; 
      margin:30px auto; 
      padding:16px; 
      background:linear-gradient(135deg,var(--p),var(--p2)); 
      color:#fff; 
      border:none; 
      border-radius:999px; 
      font-size:18px; 
      font-weight:950; 
      cursor:pointer; 
      text-decoration:none;
      text-align:center;
      transition: transform 0.12s ease;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    textarea {
      width:100%;
      min-height:150px;
      padding:16px;
      border-radius:12px;
      border:1px solid #ddd;
      font-size:16px;
      margin-top:12px;
      resize: vertical;
    }
    textarea:focus {
      outline: none;
      border-color: var(--p);
      box-shadow: 0 0 0 3px rgba(255,77,109,0.15);
    }
    audio {
      width:100%;
      margin-top:16px;
    }
    .membership-info {
      text-align: center;
      font-size: 14px;
      color: var(--muted);
      margin-top: 10px;
    }
    .download-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      max-width: 300px;
      margin: 12px auto 0;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 12px;
      background: #fff;
      color: var(--ink);
      font-weight: 900;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.12s ease;
    }
    .download-btn:hover {
      transform: translateY(-1px);
      background: #f9fafb;
    }
    .download-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .slider-container {
      margin: 20px 0;
    }
    .slider-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--ink);
    }
    .slider-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .slider-wrapper input[type="range"] {
      flex: 1;
    }
    .slider-value {
      min-width: 60px;
      font-weight: 900;
      color: var(--p);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h1>ğŸ’ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡å°‚ç”¨ãƒšãƒ¼ã‚¸</h1>
      <div id="status" class="status checking">ç¢ºèªä¸­...</div>
      <p id="membership-info" class="membership-info"></p>

      <!-- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ é™å®šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div id="premium-content" style="display:none;">
        <h2 style="text-align:center; margin-bottom:40px;">ğŸ‰ ã‚ˆã†ã“ãã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã•ã‚“ï¼</h2>

        <!-- é«˜é€Ÿç‰ˆãƒœã‚¤ã‚¹ãƒ¡ãƒ¼ã‚«ãƒ¼ -->
        <section style="margin-top:40px;">
          <h3 style="text-align:center;">ğŸš€ é«˜é€Ÿå®‰å€AIãƒœã‚¤ã‚¹ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆãƒ—ãƒ¬ãƒŸã‚¢ãƒ å°‚ç”¨ï¼‰</h3>
          <p style="text-align:center; color:var(--muted); font-size:14px;">é€šå¸¸ç‰ˆã‚ˆã‚Šé«˜é€Ÿãƒ»é«˜å“è³ªãªéŸ³å£°åˆæˆ</p>
          <textarea id="premium-text" placeholder="ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ï¼ˆé«˜é€Ÿãƒ»é«˜å“è³ªåˆæˆï¼‰"></textarea>

          <!-- æ–°è¦è¿½åŠ ï¼šé€Ÿåº¦ãƒ»ãƒ”ãƒƒãƒèª¿æ•´ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
          <div class="slider-container">
            <div>
              <label class="slider-label">é€Ÿåº¦</label>
              <div class="slider-wrapper">
                <input type="range" id="speed-slider" min="0.5" max="2.0" step="0.05" value="1.0">
                <span id="speed-value" class="slider-value">1.00</span>
              </div>
            </div>
            <div style="margin-top:16px;">
              <label class="slider-label">ãƒ”ãƒƒãƒ</label>
              <div class="slider-wrapper">
                <input type="range" id="pitch-slider" min="-0.5" max="0.5" step="0.05" value="0.0">
                <span id="pitch-value" class="slider-value">0.00</span>
              </div>
            </div>
          </div>

          <button id="premium-generate" class="btn-primary" style="margin-top:12px;">ğŸ¤ é«˜é€Ÿåˆæˆç”Ÿæˆ</button>
          <div id="premium-tts-status" style="margin-top:12px; font-weight:900; color:var(--p); text-align:center;"></div>
          <audio id="premium-audio" controls style="display:none;"></audio>
          <button id="premium-download" class="download-btn" style="display:none;" disabled>
            ğŸ“¥ éŸ³å£°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </button>
        </section>

        <!-- é™å®šå‹•ç”» -->
        <section style="margin-top:60px;">
          <h3 style="text-align:center;">ğŸ“¹ é™å®šã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‹•ç”»</h3>
          <p style="text-align:center; color:var(--muted); font-size:14px; margin-bottom:20px;">ãƒ¡ãƒ³ãƒãƒ¼é™å®šã®ç‰¹åˆ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</p>
          <div style="display:grid; gap:20px; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); margin-top:20px;">
            <iframe src="https://www.youtube.com/embed/é™å®šå‹•ç”»ID1" allowfullscreen style="width:100%; aspect-ratio:16/9; border-radius:12px; border:none;"></iframe>
            <iframe src="https://www.youtube.com/embed/é™å®šå‹•ç”»ID2" allowfullscreen style="width:100%; aspect-ratio:16/9; border-radius:12px; border:none;"></iframe>
          </div>
        </section>

        <!-- é™å®šç”»åƒ -->
        <section style="margin-top:60px; text-align:center;">
          <h3>ğŸ–¼ é™å®šç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼</h3>
          <p style="color:var(--muted); font-size:14px; margin-bottom:20px;">ã“ã“ã§ã—ã‹è¦‹ã‚Œãªã„ç‰¹åˆ¥ãªç”»åƒ</p>
          <div style="display:flex; flex-direction:column; align-items:center; gap:20px; margin-top:20px;">
            <img src="images/premium-01.webp" alt="é™å®šç”»åƒ1" style="max-width:100%; border-radius:16px; box-shadow:var(--shadow);">
            <img src="images/premium-02.webp" alt="é™å®šç”»åƒ2" style="max-width:100%; border-radius:16px; box-shadow:var(--shadow);">
          </div>
        </section>

        <!-- ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹ -->
        <div style="text-align:center; margin-top:60px;">
          <a href="/" class="btn-primary" style="background:#fff; color:var(--ink); border:2px solid #ddd;">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
        </div>
      </div>

      <!-- éä¼šå“¡ç”¨ -->
      <div id="non-premium" style="display:none; text-align:center;">
        <p style="font-size:18px; margin-bottom:30px;">ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡é™å®šã§ã™ã€‚</p>
        <a href="/#membership" class="btn-primary">âœ¨ ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã«åŠ å…¥ã™ã‚‹</a>
        <a href="/" class="btn-primary" style="background:#fff; color:var(--ink); border:2px solid #ddd; margin-top:12px;">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
      </div>

      <!-- ãƒ­ã‚°ã‚¤ãƒ³å¿…è¦ -->
      <div id="need-login" style="display:none; text-align:center;">
        <p style="font-size:18px; margin-bottom:30px;">ã“ã®ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
        <a href="/#membership" class="btn-primary">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</a>
        <a href="/" class="btn-primary" style="background:#fff; color:var(--ink); border:2px solid #ddd; margin-top:12px;">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabaseUrl = "https://fdtaesossfqfhtpoesjn.supabase.co";
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkdGFlc29zc2ZxZmh0cG9lc2puIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5Mzc1MzEsImV4cCI6MjA4MjUxMzUzMX0.AJQSaYIhaTBf338f4gfMGGQ-4hRARxcPSWRY3ReCFFk";
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const statusEl = document.getElementById('status');
    const membershipInfoEl = document.getElementById('membership-info');
    const premiumContent = document.getElementById('premium-content');
    const nonPremium = document.getElementById('non-premium');
    const needLogin = document.getElementById('need-login');

    // è¡¨ç¤ºçŠ¶æ…‹ã‚’ç®¡ç†
    function showState(state) {
      premiumContent.style.display = 'none';
      nonPremium.style.display = 'none';
      needLogin.style.display = 'none';
      
      if (state === 'premium') {
        premiumContent.style.display = 'block';
      } else if (state === 'not-premium') {
        nonPremium.style.display = 'block';
      } else if (state === 'need-login') {
        needLogin.style.display = 'block';
      }
    }

    async function checkPremiumStatus() {

      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        statusEl.textContent = "âš ï¸ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™";
        statusEl.className = "status not-premium";
        membershipInfoEl.textContent = "";
        showState('need-login');
        return false;
      }

      const { data, error } = await supabase
        .from('subscriptions')
        .select('status, current_period_end')
        .eq('user_id', user.id)
        .in('status', ['active', 'trialing'])
        .order('created_at', { ascending: false })
        .limit(1)
        .maybeSingle();

      if (error) {
        console.error('Subscription check error:', error);
        statusEl.textContent = "âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼‰";
        statusEl.className = "status not-premium";
        membershipInfoEl.textContent = "ã‚¨ãƒ©ãƒ¼: " + error.message;
        showState('not-premium');
        return false;
      }

      const isPremium = data && ['active', 'trialing'].includes(data.status);

      if (isPremium) {
        statusEl.textContent = "âœ… ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡èªè¨¼å®Œäº†ï¼";
        statusEl.className = "status premium";
        
        if (data.current_period_end) {
          const endDate = new Date(data.current_period_end).toLocaleDateString('ja-JP', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
          membershipInfoEl.textContent = `æ¬¡å›æ›´æ–°æ—¥: ${endDate}`;
          membershipInfoEl.style.color = '#fff';
        }
        
        showState('premium');
      } else {
        statusEl.textContent = "âŒ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã§ã¯ã‚ã‚Šã¾ã›ã‚“";
        statusEl.className = "status not-premium";
        membershipInfoEl.textContent = user.email + " ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­";
        showState('not-premium');
      }

      return isPremium;
    }

    // ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆStripeæ±ºæ¸ˆç›´å¾Œç”¨ï¼‰
    async function startPolling(maxAttempts = 30, interval = 2000) {
      let attempts = 0;
      statusEl.textContent = "â³ æ±ºæ¸ˆåæ˜ ã‚’ç¢ºèªä¸­...";
      statusEl.className = "status checking";
      membershipInfoEl.textContent = "ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ï¼ˆæœ€å¤§1åˆ†ç¨‹åº¦ï¼‰";

      const poll = setInterval(async () => {
        attempts++;
        console.log(`Polling attempt ${attempts}/${maxAttempts}`);
        
        const isPremium = await checkPremiumStatus();
        
        if (isPremium || attempts >= maxAttempts) {
          clearInterval(poll);
          
          if (!isPremium && attempts >= maxAttempts) {
            statusEl.textContent = "â° åæ˜ ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™";
            statusEl.className = "status checking";
            membershipInfoEl.innerHTML = `
              æ•°åˆ†å¾…ã£ã¦ã‹ã‚‰<a href="javascript:location.reload()" style="color:var(--p);text-decoration:underline;">ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰</a>ã—ã¦ãã ã•ã„ã€‚<br>
              ãã‚Œã§ã‚‚åæ˜ ã•ã‚Œãªã„å ´åˆã¯<a href="mailto:support@example.com" style="color:var(--p);text-decoration:underline;">ãŠå•ã„åˆã‚ã›</a>ãã ã•ã„ã€‚
            `;
          }
        }
      }, interval);
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­
    function subscribeToChanges() {
      supabase
        .channel('premium-subscriptions')
        .on('postgres_changes', { 
          event: '*', 
          schema: 'public', 
          table: 'subscriptions' 
        }, (payload) => {
          console.log('Subscription changed:', payload);
          checkPremiumStatus();
        })
        .subscribe();
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    window.addEventListener('load', async () => {
      const urlParams = new URLSearchParams(window.location.search);

      if (urlParams.has('session_id')) {
        const newUrl = window.location.pathname;
        history.replaceState({}, '', newUrl);
        await startPolling();
      } else {
        await checkPremiumStatus();
      }
      
      subscribeToChanges();
    });

    // èªè¨¼çŠ¶æ…‹å¤‰åŒ–æ™‚ã‚‚ãƒã‚§ãƒƒã‚¯
    supabase.auth.onAuthStateChange((event, session) => {
      console.log('Auth state changed:', event);
      checkPremiumStatus();
    });

    // ===== é«˜é€ŸTTSï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰ =====
    let currentAudioUrl = null;
    let currentAudioBlob = null;

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤è¡¨ç¤ºæ›´æ–°
    const speedSlider = document.getElementById('speed-slider');
    const speedValue = document.getElementById('speed-value');
    const pitchSlider = document.getElementById('pitch-slider');
    const pitchValue = document.getElementById('pitch-value');

    speedSlider.addEventListener('input', () => {
      speedValue.textContent = parseFloat(speedSlider.value).toFixed(2);
    });
    pitchSlider.addEventListener('input', () => {
      pitchValue.textContent = parseFloat(pitchSlider.value).toFixed(2);
    });

    document.getElementById('premium-generate')?.addEventListener('click', async () => {
      const text = document.getElementById('premium-text').value.trim();
      if (!text) return alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

      const speaker = 1099527840;
      const speed = parseFloat(speedSlider.value);
      const pitch = parseFloat(pitchSlider.value);

      const btn = document.getElementById('premium-generate');
      const ttsStatus = document.getElementById('premium-tts-status');
      const audioEl = document.getElementById('premium-audio');
      const downloadBtn = document.getElementById('premium-download');

      btn.disabled = true;
      btn.textContent = "ğŸ”„ åˆæˆä¸­...";
      ttsStatus.textContent = "åˆæˆå‡¦ç†ä¸­...";
      downloadBtn.disabled = true;

      if (currentAudioUrl) {
        URL.revokeObjectURL(currentAudioUrl);
      }

      try {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ï¼šã¾ãšãƒ—ãƒ¬ãƒŸã‚¢ãƒ  â†’ å¤±æ•—ã—ãŸã‚‰æ¨™æº–
        const endpoints = ['/api/tts_premium', '/api/tts'];
        let usedEndpoint = null;

        for (const endpoint of endpoints) {
          try {
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text, speaker, speed, pitch })
            });

            if (response.ok) {
              usedEndpoint = endpoint;
              currentAudioBlob = await response.blob();
              break;
            }
          } catch (err) {
            // ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯å¤±æ•— â†’ æ¬¡ã¸
            console.warn(`Endpoint ${endpoint} failed:`, err);
          }
        }

        if (!currentAudioBlob) {
          throw new Error("ä¸¡æ–¹ã®APIã§åˆæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ï¼‰");
        }

        currentAudioUrl = URL.createObjectURL(currentAudioBlob);
        
        audioEl.src = currentAudioUrl;
        audioEl.style.display = 'block';
        audioEl.play();
        
        downloadBtn.style.display = 'block';
        downloadBtn.disabled = false;

        // ä½¿ç”¨ã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¿œã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›´
        if (usedEndpoint === '/api/tts_premium') {
          ttsStatus.textContent = "âœ… é«˜é€Ÿåˆæˆå®Œäº†ï¼";
        } else {
          ttsStatus.textContent = "âœ… åˆæˆå®Œäº†ï¼ˆãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã§æ¨™æº–ãƒ¢ãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰";
        }
      } catch (err) {
        console.error('TTS Error:', err);
        ttsStatus.textContent = "âŒ ã‚¨ãƒ©ãƒ¼: " + err.message;
        audioEl.style.display = 'none';
        downloadBtn.style.display = 'none';
      } finally {
        btn.disabled = false;
        btn.textContent = "ğŸ¤ é«˜é€Ÿåˆæˆç”Ÿæˆ";
      }
    });

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
    document.getElementById('premium-download')?.addEventListener('click', () => {
      if (!currentAudioBlob) return;
      
      const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
      const filename = `abe_voice_premium_${timestamp}.wav`;
      
      const a = document.createElement('a');
      a.href = currentAudioUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
  </script>
</body>
</html>