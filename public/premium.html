<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡å°‚ç”¨ãƒšãƒ¼ã‚¸ | æ™‹ãƒãƒ«ã‚µãƒ³ch</title>
  <style>
    :root{
      --bgA:#fff4f6; --bgB:#fffdfe; --bgC:#f3fdff; --ink:#1f2937; --muted:#6b7280;
      --p:#ff4d6d; --p2:#ffb703; --p3:#4cc9f0; --shadow: 0 18px 50px rgba(0,0,0,0.12);
      --r: 18px; --max: 1100px;
    }
    body { 
      margin:0; 
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", sans-serif; 
      background: linear-gradient(135deg, var(--bgA), var(--bgC)); 
      min-height:100vh; 
      color:var(--ink); 
    }
    .container { 
      width: min(var(--max), calc(100% - 28px)); 
      margin-inline:auto; 
      padding:60px 0; 
    }
    .panel { 
      background:#fff; 
      border-radius:var(--r); 
      box-shadow:var(--shadow); 
      padding:40px; 
      max-width: 900px;
      margin: 0 auto;
    }
    h1 { 
      text-align:center; 
      font-size:clamp(24px,5vw,36px); 
      margin-bottom:20px; 
    }
    .status { 
      text-align:center; 
      font-size:20px; 
      font-weight:900; 
      padding:20px; 
      border-radius:16px; 
      margin-bottom:40px; 
    }
    .premium { 
      background:linear-gradient(135deg,var(--p),var(--p2)); 
      color:#fff; 
    }
    .not-premium { 
      background:#fee2e2; 
      color:#991b1b; 
    }
    .btn-primary { 
      display:block; 
      width:100%; 
      max-width:300px; 
      margin:30px auto; 
      padding:16px; 
      background:linear-gradient(135deg,var(--p),var(--p2)); 
      color:#fff; 
      border:none; 
      border-radius:999px; 
      font-size:18px; 
      font-weight:950; 
      cursor:pointer; 
      text-decoration:none;
      text-align:center;
    }
    textarea {
      width:100%;
      min-height:150px;
      padding:16px;
      border-radius:12px;
      border:1px solid #ddd;
      font-size:16px;
      margin-top:12px;
    }
    audio {
      width:100%;
      margin-top:16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h1>ğŸ’ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡å°‚ç”¨ãƒšãƒ¼ã‚¸</h1>
      <div id="status" class="status">ç¢ºèªä¸­...</div>

      <!-- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ é™å®šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div id="premium-content" style="display:none;">
        <h2 style="text-align:center; margin-bottom:40px;">ğŸ‰ ã‚ˆã†ã“ãã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã•ã‚“ï¼</h2>

        <!-- é«˜é€Ÿç‰ˆãƒœã‚¤ã‚¹ãƒ¡ãƒ¼ã‚«ãƒ¼ -->
        <section style="margin-top:40px;">
          <h3 style="text-align:center;">ğŸš€ é«˜é€Ÿå®‰å€AIãƒœã‚¤ã‚¹ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆãƒ—ãƒ¬ãƒŸã‚¢ãƒ å°‚ç”¨ï¼‰</h3>
          <textarea id="premium-text" placeholder="ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ï¼ˆé«˜é€Ÿãƒ»é«˜å“è³ªåˆæˆï¼‰"></textarea>
          <button id="premium-generate" class="btn-primary" style="margin-top:12px;">é«˜é€Ÿåˆæˆç”Ÿæˆ</button>
          <div id="premium-status" style="margin-top:12px; font-weight:900; color:var(--p); text-align:center;"></div>
          <audio id="premium-audio" controls></audio>
        </section>

        <!-- é™å®šå‹•ç”» -->
        <section style="margin-top:60px;">
          <h3 style="text-align:center;">ğŸ“¹ é™å®šã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‹•ç”»</h3>
          <div style="display:grid; gap:20px; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); margin-top:20px;">
            <iframe src="https://www.youtube.com/embed/é™å®šå‹•ç”»ID1" allowfullscreen style="width:100%; aspect-ratio:16/9; border-radius:12px;"></iframe>
            <iframe src="https://www.youtube.com/embed/é™å®šå‹•ç”»ID2" allowfullscreen style="width:100%; aspect-ratio:16/9; border-radius:12px;"></iframe>
          </div>
        </section>

        <!-- é™å®šç”»åƒ -->
        <section style="margin-top:60px; text-align:center;">
          <h3>ğŸ–¼ é™å®šç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼</h3>
          <div style="display:flex; flex-direction:column; align-items:center; gap:20px; margin-top:20px;">
            <img src="images/premium-01.webp" alt="é™å®šç”»åƒ1" style="max-width:100%; border-radius:16px; box-shadow:var(--shadow);">
            <img src="images/premium-02.webp" alt="é™å®šç”»åƒ2" style="max-width:100%; border-radius:16px; box-shadow:var(--shadow);">
          </div>
        </section>
      </div>

      <!-- éä¼šå“¡ç”¨ -->
      <div id="non-premium" style="display:none; text-align:center;">
        <p style="font-size:18px; margin-bottom:30px;">ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡é™å®šã§ã™ã€‚</p>
        <a href="/" class="btn-primary">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
        <p style="margin-top:20px;"><a href="/" style="color:var(--p); text-decoration:underline;">ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—åŠ å…¥ã¯ã“ã¡ã‚‰ã‹ã‚‰</a></p>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabaseUrl = "https://fdtaesossfqfhtpoesjn.supabase.co";
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkdGFlc29zc2ZxZmh0cG9lc2puIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5Mzc1MzEsImV4cCI6MjA4MjUxMzUzMX0.AJQSaYIhaTBf338f4gfMGGQ-4hRARxcPSWRY3ReCFFk";
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const statusEl = document.getElementById('status');
    const premiumContent = document.getElementById('premium-content');
    const nonPremium = document.getElementById('non-premium');

    async function checkPremiumStatus() {
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        statusEl.textContent = "âš ï¸ ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™";
        statusEl.className = "status not-premium";
        nonPremium.style.display = "block";
        return false;
      }

      const { data, error } = await supabase
        .from('stripe.subscriptions')  // ãƒ†ãƒ¼ãƒ–ãƒ«åä¿®æ­£
        .select('status')
        .eq('status', 'active')
        .eq('metadata->>supabase_user_id', user.id);  // metadataã§ã‚¯ã‚¨ãƒª

      if (error) {
        console.error(error);
        statusEl.textContent = "âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼‰";
        statusEl.className = "status not-premium";
        return false;
      }

      const isPremium = data && data.length > 0;

      if (isPremium) {
        statusEl.textContent = "âœ… ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡èªè¨¼å®Œäº†ï¼";
        statusEl.className = "status premium";
        premiumContent.style.display = "block";
        nonPremium.style.display = "none";
      } else {
        statusEl.textContent = "âŒ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã§ã¯ã‚ã‚Šã¾ã›ã‚“";
        statusEl.className = "status not-premium";
        nonPremium.style.display = "block";
        premiumContent.style.display = "none";
      }

      return isPremium;
    }

    // ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆStripeæ±ºæ¸ˆç›´å¾Œç”¨ï¼‰
    async function startPolling(maxAttempts = 30, interval = 2000) {
      let attempts = 0;
      statusEl.textContent = "ç¢ºèªä¸­...ï¼ˆæ±ºæ¸ˆåæ˜ å¾…ã¡ï¼‰";
      statusEl.className = "status";

      const poll = setInterval(async () => {
        attempts++;
        const isPremium = await checkPremiumStatus();
        if (isPremium || attempts >= maxAttempts) {
          clearInterval(poll);
          if (!isPremium && attempts >= maxAttempts) {
            statusEl.textContent = "â° åæ˜ ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚æ•°åˆ†å¾…ã£ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚";
            statusEl.className = "status not-premium";
          }
        }
      }, interval);
    }

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­
    function subscribeToChanges() {
      supabase
        .channel('premium-subscriptions')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'subscriptions' }, () => {
          checkPremiumStatus();
        })
        .subscribe();
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    window.addEventListener('load', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('session_id')) {
        // Stripeã‹ã‚‰æˆ»ã£ã¦ããŸå ´åˆ â†’ ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
        await startPolling();
      } else {
        await checkPremiumStatus();
      }
      subscribeToChanges();
    });

    // èªè¨¼çŠ¶æ…‹å¤‰åŒ–æ™‚ã‚‚ãƒã‚§ãƒƒã‚¯
    supabase.auth.onAuthStateChange(() => {
      checkPremiumStatus();
    });

    // é«˜é€ŸTTSä¾‹ï¼ˆå®Ÿéš›ã®APIã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ï¼‰
    document.getElementById('premium-generate')?.addEventListener('click', async () => {
      const text = document.getElementById('premium-text').value.trim();
      if (!text) return alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

      const premiumStatus = document.getElementById('premium-status');
      premiumStatus.textContent = "é«˜é€Ÿåˆæˆä¸­...";

      try {
        const response = await fetch('/api/tts-premium', {  // ã¾ãŸã¯æ—¢å­˜ã® /api/tts ã«ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, premium: true })
        });

        if (!response.ok) throw new Error('åˆæˆå¤±æ•—');

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        document.getElementById('premium-audio').src = url;
        premiumStatus.textContent = "âœ… é«˜é€Ÿåˆæˆå®Œäº†ï¼";
      } catch (err) {
        premiumStatus.textContent = "âŒ ã‚¨ãƒ©ãƒ¼: " + err.message;
      }
    });
  </script>
</body>
</html>